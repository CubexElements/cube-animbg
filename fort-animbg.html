<link href="../polymer/polymer.html" rel="import">

<!--
Fortifi Animated Background

Default Usage Example:

    <fort-animbg></fort-animbg>

Add Custom Colour Example (any valid CSS background value):

    <fort-animbg color="red"></fort-animbg>

Fill Containing Element Example:

    <fort-animbg fill></fort-animbg>

Polygon Rotation Speed Example:

    <fort-animbg speed="8000"></fort-animbg>

Define Fixed Polygon Size Example (polygon size = size):

    <fort-animbg size="200" fixed-size></fort-animbg>

Define Dynamic Polygon Size Example (polygon size = (canvas.width + canvas.height) / size):

    <fort-animbg size="5"></fort-animbg>

Default Polygon Size = (canvas.width + canvas.height) / 20)

@demo demo/index.html
-->


<dom-module id="fort-animbg" color="[[color]]" size="[[size]]" speed="[[speed]]" fixed-size fill>
  <template>
    <style>
      :host {
        position: relative;
        display: inline-block;
      }

      :host[fill] {
        width: 100%;
        height: 100%;
        overflow: hidden;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        flex: auto;
        align-items: center;
        justify-content: center;
      }

      .animated-canvas {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        z-index: -1;

        background-color: var(--fort-animbg-background-color) !important;
      }
    </style>

    <div class="animated-canvas" style$="background-color: [[color]];"></div>
    <content></content>
  </template>

  <script>
    Polymer(
      {
        is:            'fort-animbg',
        properties:    {
          fill:      Boolean,
          fixedSize: Boolean,
          color:     {
            type:     String,
            value:    '#fff',
            observer: '_colorChanged'
          },
          size:      {
            type:     String,
            value:    '20',
            observer: '_sizeChanged'
          },
          speed:     {
            type:  String,
            value: '8000'
          }
        },
        _sizeChanged:  function (newVal)
                       {
                         this.size = this.size.replace(/\D/g, '');

                         if(!this.size.length)
                         {
                           this.size = '20';
                           return console.error(
                             'Invalid value (' + newVal + ') provided for "size" property. ' +
                             'Value must be a number. Default value (' + this.size + ') used'
                           );
                         }
                       },
        _colorChanged: function (newVal)
                       {
                         this.setAttribute('color', newVal);
                       },
        attached:      function ()
                       {
                         var self = this;
                         var canvas = this.$$('.animated-canvas');
                         var refreshDuration = this.speed;
                         var refreshTimeout;
                         var numPointsX;
                         var numPointsY;
                         var unitWidth;
                         var unitHeight;
                         var points;

                         function animatedCanvas()
                         {
                           var canvasWidth = canvas.offsetWidth;
                           var canvasHeight = canvas.offsetHeight;
                           var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');

                           svg.setAttribute('width', canvasWidth.toString());
                           svg.setAttribute('height', canvasHeight.toString());

                           canvas.appendChild(svg);

                           var unitSize = (canvasWidth + canvasHeight) / self.size;
                           if(self.fixedSize)
                           {
                             unitSize = self.size;
                           }

                           numPointsX = Math.ceil(canvasWidth / unitSize) + 1;
                           numPointsY = Math.ceil(canvasHeight / unitSize) + 1;
                           unitWidth = Math.ceil(canvasWidth / (numPointsX - 1));
                           unitHeight = Math.ceil(canvasHeight / (numPointsY - 1));

                           points = [];

                           for(var y = 0; y < numPointsY; y++)
                           {
                             for(var x = 0; x < numPointsX; x++)
                             {
                               points.push(
                                 {
                                   x:       unitWidth * x,
                                   y:       unitHeight * y,
                                   originX: unitWidth * x,
                                   originY: unitHeight * y
                                 }
                               );
                             }
                           }

                           randomize();

                           for(var i = 0; i < points.length; i++)
                           {
                             if(points[i].originX != unitWidth * (numPointsX - 1) && points[i].originY != unitHeight * (numPointsY - 1))
                             {
                               if(!points[i + numPointsX])
                               {
                                 continue;
                               }

                               var topLeftX = points[i].x;
                               var topLeftY = points[i].y;
                               var topRightX = points[i + 1].x;
                               var topRightY = points[i + 1].y;
                               var bottomLeftX = points[i + numPointsX].x;
                               var bottomLeftY = points[i + numPointsX].y;
                               var bottomRightX = points[i + numPointsX + 1].x;
                               var bottomRightY = points[i + numPointsX + 1].y;

                               var rando = Math.floor(Math.random() * 2);

                               for(var n = 0; n < 2; n++)
                               {
                                 var polygon = document.createElementNS(svg.namespaceURI, 'polygon');

                                 if(rando == 0)
                                 {
                                   if(n == 0)
                                   {
                                     polygon.point1 = i;
                                     polygon.point2 = i + numPointsX;
                                     polygon.point3 = i + numPointsX + 1;
                                     polygon.setAttribute(
                                       'points',
                                       topLeftX + ',' + topLeftY + ' ' + bottomLeftX + ',' + bottomLeftY + ' ' + bottomRightX + ',' + bottomRightY
                                     );
                                   }
                                   else if(n == 1)
                                   {
                                     polygon.point1 = i;
                                     polygon.point2 = i + 1;
                                     polygon.point3 = i + numPointsX + 1;
                                     polygon.setAttribute(
                                       'points',
                                       topLeftX + ',' + topLeftY + ' ' + topRightX + ',' + topRightY + ' ' + bottomRightX + ',' + bottomRightY
                                     );
                                   }
                                 }
                                 else if(rando == 1)
                                 {
                                   if(n == 0)
                                   {
                                     polygon.point1 = i;
                                     polygon.point2 = i + numPointsX;
                                     polygon.point3 = i + 1;
                                     polygon.setAttribute(
                                       'points',
                                       topLeftX + ',' + topLeftY + ' ' + bottomLeftX + ',' + bottomLeftY + ' ' + topRightX + ',' + topRightY
                                     );
                                   }
                                   else if(n == 1)
                                   {
                                     polygon.point1 = i + numPointsX;
                                     polygon.point2 = i + 1;
                                     polygon.point3 = i + numPointsX + 1;
                                     polygon.setAttribute(
                                       'points',
                                       bottomLeftX + ',' + bottomLeftY + ' ' + topRightX + ',' + topRightY + ' ' + bottomRightX + ',' + bottomRightY
                                     );
                                   }
                                 }
                                 polygon.setAttribute('fill', 'rgba(0,0,0,' + (Math.random() / 10) + ')');

                                 var animate = document.createElementNS('http://www.w3.org/2000/svg', 'animate');
                                 animate.setAttribute('fill', 'freeze');
                                 animate.setAttribute('attributeName', 'points');
                                 animate.setAttribute('dur', refreshDuration + 'ms');
                                 animate.setAttribute('calcMode', 'linear');

                                 polygon.appendChild(animate);
                                 svg.appendChild(polygon);
                               }
                             }
                           }

                           refresh();
                         }

                         function randomize()
                         {
                           for(var i = 0; i < points.length; i++)
                           {
                             if(points[i].originX != 0 && points[i].originX != unitWidth * (numPointsX - 1))
                             {
                               points[i].x = points[i].originX + Math.random() * unitWidth - unitWidth / 2;
                             }
                             if(points[i].originY != 0 && points[i].originY != unitHeight * (numPointsY - 1))
                             {
                               points[i].y = points[i].originY + Math.random() * unitHeight - unitHeight / 2;
                             }
                           }
                         }

                         function refresh()
                         {
                           randomize();
                           for(var i = 0; i < canvas.querySelector('svg').childNodes.length; i++)
                           {
                             var polygon = canvas.querySelector('svg').childNodes[i];
                             var animate = polygon.firstChild;

                             if(animate.getAttribute('to'))
                             {
                               animate.setAttribute('from', animate.getAttribute('to'));
                             }
                             animate.setAttribute(
                               'to',
                               points[polygon.point1].x + ',' + points[polygon.point1].y + ' '
                               + points[polygon.point2].x + ',' + points[polygon.point2].y + ' '
                               + points[polygon.point3].x + ',' + points[polygon.point3].y
                             );
                             try
                             {
                               //noinspection JSUnresolvedFunction
                               animate.beginElement();
                             }
                             catch(err)
                             {
                             }
                           }
                           refreshTimeout = setTimeout(refresh, refreshDuration);
                         }

                         function onResize()
                         {
                           canvas.querySelector('svg').remove();
                           clearTimeout(refreshTimeout);
                           animatedCanvas();
                         }

                         animatedCanvas();
                         if(window.attachEvent)
                         {
                           window.attachEvent('onresize', onResize);
                         }
                         else if(window.addEventListener)
                         {
                           window.addEventListener('resize', onResize, true);
                         }
                       }
      }
    );
  </script>
</dom-module>
